# 测试说明

本目录包含 `lrh-eslint` 项目的测试文件。

## 测试文件结构

- `cli.test.ts` - CLI 命令行接口测试
- `linter.test.ts` - 单元测试，测试 linter 核心功能
- `rules/` - 规则相关的测试文件
  - `index.test.ts` - 规则管理系统测试
  - `no_unused_vars.test.ts` - 未使用变量检测规则测试
  - `semi.test.ts` - 分号检测规则测试

## 运行测试

### 运行所有测试
```bash
npm test
```

### 运行测试并显示覆盖率
```bash
npm run test:coverage
```

## 测试内容

### CLI 测试 (`cli.test.ts`)

测试命令行接口的核心逻辑：

1. **CLI 逻辑测试**
   - ✅ 没有参数时退出（退出码1）
   - ✅ 同时传递 global 和 path 参数时退出（退出码1）
   - ✅ 正确处理只传递路径参数的情况
   - ✅ 正确处理只传递 global 参数的情况

2. **选项解析逻辑**
   - ✅ 正确解析 global 选项为 true/false/undefined
   - ✅ 处理 global 选项的严格比较

3. **路径处理逻辑**
   - ✅ 使用 path.resolve 转换相对路径为绝对路径
   - ✅ 处理绝对路径、包含空格的路径、空字符串路径

4. **参数组合场景**
   - ✅ 处理多个参数（只使用第一个）
   - ✅ 处理空参数数组

5. **业务逻辑验证**
   - ✅ 验证四种参数组合的逻辑

6. **Commander.js 集成概念验证**
   - ✅ 验证 commander 程序配置的概念
   - ✅ 验证选项和参数的访问模式

### 单元测试 (`linter.test.ts`)

测试 linter 核心功能（已适配新的 `initListenersMap` 函数）：

1. **getCode** - 文件读取功能
   - ✅ 成功读取文件内容
   - ✅ 处理文件读取错误

2. **getAST** - AST 解析功能
   - ✅ 正确解析代码生成 AST
   - ✅ 处理 AST 解析错误

3. **traverseAST** - AST 遍历功能
   - ✅ 正确调用 estraverse.traverse
   - ✅ 正确处理监听器映射

4. **worker** - 单个文件处理功能
   - ✅ 处理单个文件的完整流程
   - ✅ 处理文件读取失败的情况
   - ✅ 处理 AST 解析失败的情况

5. **run** - 主运行函数
   - ✅ 处理指定路径的文件且无错误时退出码为0
   - ✅ 处理指定路径的文件且有错误时退出码为1
   - ✅ 处理无参数情况
   - ✅ 处理参数优先级（path 优先于 isGlobal）

### 规则测试 (`rules/`)

#### 规则管理系统 (`rules/index.test.ts`)

测试规则系统的核心功能（已适配新的函数导出方式）：

1. **模块导出**
   - ✅ 导出一个函数
   - ✅ 返回一个 Map 实例
   - ✅ 返回的 Map 应该包含规则监听器

2. **规则系统集成**
   - ✅ 正常导入和初始化
   - ✅ 初始化监听器映射
   - ✅ 每次调用都返回新的 Map 实例

3. **配置处理逻辑**
   - ✅ 处理各种配置场景
   - ✅ 默认规则生成逻辑
   - ✅ 规则融合逻辑

4. **错误处理**
   - ✅ JSON 解析错误处理
   - ✅ 文件不存在处理

5. **函数行为验证**
   - ✅ 根据配置正确初始化规则
   - ✅ 在没有配置文件时使用默认规则

#### 未使用变量检测规则 (`rules/no_unused_vars.test.ts`)

测试未使用变量检测的各种场景：

1. **规则元数据**
   - ✅ 包含正确的元数据

2. **变量声明处理**
   - ✅ let/const/var 声明处理
   - ✅ 忽略非 VariableDeclarator 节点

3. **变量使用检测**
   - ✅ 直接使用检测
   - ✅ 对象属性使用检测 (obj.prop)
   - ✅ 计算属性使用检测 (obj[prop])
   - ✅ 属性名忽略处理
   - ✅ 全局对象属性忽略

4. **复合场景**
   - ✅ 多变量声明和使用
   - ✅ 变量重复使用

5. **报告格式**
   - ✅ 正确格式的报告生成

#### 分号检测规则 (`rules/semi.test.ts`)

测试分号检测规则的各种场景：

1. **规则元数据**
   - ✅ 包含正确的元数据

2. **分号检测**
   - ✅ 检测缺少分号的语句
   - ✅ 允许有分号的语句
   - ✅ 处理多个语句
   - ✅ 忽略非 Program 节点
   - ✅ 边界条件处理

3. **Tokens 处理**
   - ✅ 正确设置 tokens
   - ✅ 处理各种 token 类型

4. **报告格式**
   - ✅ 正确格式的报告生成

## 测试覆盖情况

当前测试覆盖了项目的核心功能：
- ✅ CLI 命令行接口 (`cli.ts`)
- ✅ Linter 核心逻辑 (`linter.ts`) - 已适配新的 `initListenersMap` 函数
- ✅ 规则管理系统 (`rules/index.ts`) - 已适配新的函数导出方式
- ✅ 未使用变量检测规则 (`rules/no_unused_vars.ts`)
- ✅ 分号检测规则 (`rules/semi.ts`)

## 测试统计

- **总测试文件**: 5 个
- **总测试用例**: 73 个
- **通过率**: 100% (73/73)

## 测试技术栈

- **Vitest** - 测试框架
- **Mock** - 模拟依赖（fs, path, espree, estraverse, chalk, commander）
- **TypeScript** - 类型安全的测试代码

## 最近修复的问题

### 适配 `rules/index.ts` 的重构
- ✅ 修复了从导出 Map 实例改为导出 `initListenersMap` 函数的兼容性问题
- ✅ 更新了 `linter.test.ts` 中的 mock 策略以适配新的函数签名
- ✅ 修复了 `traverseAST` 函数签名变更的测试适配
- ✅ 解决了 `errorFlag` 全局状态在测试间的污染问题

### 测试稳定性改进
- ✅ 使用 `vi.resetModules()` 确保每个测试的模块状态独立
- ✅ 动态导入模块以避免全局状态污染
- ✅ 正确处理 mock 函数的返回值格式

## 注意事项

1. 测试使用了大量的 mock 来隔离外部依赖
2. 测试覆盖了错误处理和边界情况
3. 所有测试都使用中文描述，便于理解测试目的
4. CLI 测试专注于业务逻辑验证，避免了复杂的模块导入问题
5. 规则测试专注于业务逻辑的单元测试，确保规则的正确性
6. 已适配新的 `initListenersMap` 函数导出方式，确保测试与代码重构保持同步
7. 使用模块重置策略解决全局状态污染问题，确保测试的独立性和可靠性 